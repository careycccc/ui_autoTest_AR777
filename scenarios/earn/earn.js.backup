import {
    PageRegion,
    getRegion,
    clickIfTextExists,
    handleFailure,
    verifyElementContent,
    handleTelegramJump,
    scrollToLoadAll
} from '../utils.js';


// 团队返佣

/**
 * 进入团队详情页面
 * @param {Page} page - Playwright page
 * @param {TestCase} test - Test case instance
 */
export async function earnTeamDetail(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '进入团队详情->页面已关闭，跳过操作');
        }

        // 在轮播图中找到 "My team level" 并点击 Detail
        const slideLocator = page.locator('.swiper-slide').filter({ hasText: 'My team level' });
        const slideVisible = await slideLocator.isVisible({ timeout: 5000 }).catch(() => false);

        if (!slideVisible) {
            console.log('        ℹ️ 未找到 "My team level" slide，尝试滑动查找...');
            const swiperContainer = page.locator('.swiper-container').first();
            const containerVisible = await swiperContainer.isVisible({ timeout: 3000 }).catch(() => false);

            if (containerVisible) {
                for (let i = 0; i < 5; i++) {
                    await swiperContainer.swipe({ direction: 'left' }).catch(() => { });
                    await page.waitForTimeout(500);
                    const found = await slideLocator.isVisible({ timeout: 1000 }).catch(() => false);
                    if (found) {
                        console.log(`        ✅ 找到 "My team level" slide (滑动 ${i + 1} 次)`);
                        break;
                    }
                }
            }
        }

        // 点击 Detail 按钮
        const detailButton = slideLocator.locator('text=Detail');
        const detailVisible = await detailButton.isVisible({ timeout: 3000 }).catch(() => false);

        if (!detailVisible) {
            return await handleFailure(test, '进入团队详情->Detail 按钮不可见');
        }

        await detailButton.click();
        console.log('        ✅ 已点击 Detail 按钮');

        // 切换到团队详情页面
        await test.switchToPage('进入团队详情', {
            waitForSelector: 'text=Subordinate Data',
            waitTime: 1000,
            collectPreviousPage: true
        });

        // 点击切换后的页面的Level 1，Level 2，Level 3（依次执行）
        await clickIfTextExists(page, 'Level 1', { name: '新版返佣->团队详情' });
        await clickIfTextExists(page, 'Level 2', { name: '新版返佣->团队详情' });
        await clickIfTextExists(page, 'Level 3', { name: '新版返佣->团队详情' });

        console.log('        ✅ earnTeamDetail 执行完成');
        return true;

    } catch (error) {
        return await handleFailure(test, `进入团队详情->earnTeamDetail 执行失败: ${error.message}`, { throwError: true });
    }
}

export async function earnWithdrawalRewards(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '页面已关闭，跳过操作');
        }

        // 在轮播图中找到 "My team level" 并点击 Detail
        const slideLocator = page.locator('.swiper-slide').filter({ hasText: 'My team level' });
        const slideVisible = await slideLocator.isVisible({ timeout: 5000 }).catch(() => false);

        if (!slideVisible) {
            console.log('        ℹ️ 未找到 "My team level" slide，尝试滑动查找...');

            const swiperContainer = page.locator('.swiper-container').first();
            const containerVisible = await swiperContainer.isVisible({ timeout: 3000 }).catch(() => false);

            if (containerVisible) {
                for (let i = 0; i < 5; i++) {
                    await swiperContainer.swipe({ direction: 'left' }).catch(() => { });
                    await page.waitForTimeout(500);

                    const found = await slideLocator.isVisible({ timeout: 1000 }).catch(() => false);
                    if (found) {
                        console.log(`        ✅ 找到 "My team level" slide (滑动 ${i + 1} 次)`);
                        break;
                    }
                }
            }
        }

        // 点击 Detail 按钮
        const detailButton = slideLocator.locator('text=Detail');
        const detailVisible = await detailButton.isVisible({ timeout: 3000 }).catch(() => false);

        if (!detailVisible) {
            return await handleFailure(test, 'Detail 按钮不可见，无法继续');
        }

        await detailButton.click();
        console.log('        ✅ 已点击 Detail 按钮');

        // 切换到 Withdrawal rewards 页面
        await test.switchToPage('进入返佣的Withdrawal rewards界面', {
            waitForSelector: 'text=Withdrawal rewards',
            waitTime: 1000,
            collectPreviousPage: true
        });

        // 等待页面稳定
        await page.waitForTimeout(1000);

        console.log('        ✅ earnWithdrawalRewards 执行完成');
        return true;

    } catch (error) {
        return await handleFailure(test, `Withdrawal rewards 操作失败: ${error.message}`, { throwError: true });
    }
}


/**
 * 在我的团队的Withdrawal rewards里面点击Claim，Detail按钮
 * @param {Page} page - Playwright page
 * @param {TestCase} test - Test case instance
 */
export async function Withdrawalrewards(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '页面已关闭，跳过操作');
        }

        const region = new PageRegion(page);

        // 1.进入Withdrawal rewards区域
        await region.enterRegion('.withdrawal', { hasText: 'Withdrawal rewards' });
        console.log('        ✓ 已进入 Withdrawal rewards 区域');

        // 2.检查 Claim 按钮状态（按钮是灰色disabled状态，跳过点击）
        const claimButton = region.find('#withdrawalDetail');
        const isVisible = await claimButton.isVisible({ timeout: 3000 }).catch(() => false);

        if (isVisible) {
            // 检查按钮是否被禁用
            const isDisabled = await claimButton.evaluate(el => el.classList.contains('disabled')).catch(() => true);

            if (isDisabled) {
                console.log('        ℹ️ Claim 按钮已禁用（灰色），跳过点击');
            } else {
                // 只有在按钮可用时才点击
                await claimButton.click({ force: true, timeout: 5000 });
                console.log('        ✓ 已点击 Claim 按钮');
                await page.waitForTimeout(1000);
            }
        } else {
            console.log('        ℹ️ Claim 按钮不可见');
        }

        // 3.直接点击 Detail 按钮（这个才是主要操作）
        const detailButton = region.findByText('Detail');
        const detailVisible = await detailButton.isVisible({ timeout: 3000 }).catch(() => false);

        if (!detailVisible) {
            return await handleFailure(test, 'Detail 按钮不可见，无法继续');
        }

        // 使用 force: true 强制点击，忽略可能的遮挡
        await detailButton.click({ force: true, timeout: 5000 });
        console.log('        ✓ 已点击 Detail 按钮');
        await page.waitForTimeout(1500);

        // 4.切换到新页面 Reward Details
        await test.switchToPage('返佣详情页面Reward Details', {
            waitForSelector: 'text=Reward Details',
            waitTime: 1000,
            collectPreviousPage: true
        });

        // 5.点击详情里面的筛选按钮
        await clickIfTextExists(page, 'All', { name: '新版返佣->佣金详情', waitAfter: 500 });
        await clickIfTextExists(page, 'Bet', { name: '新版返佣->佣金详情', waitAfter: 500 });
        await clickIfTextExists(page, 'Deposit', { name: '新版返佣->佣金详情', waitAfter: 500 });
        await clickIfTextExists(page, 'Task', { name: '新版返佣->佣金详情', waitAfter: 500 });
        await clickIfTextExists(page, 'Invite', { name: '新版返佣->佣金详情', waitAfter: 500 });

        console.log('        ✅ Withdrawal rewards 操作完成');
        return true;
    } catch (error) {
        return await handleFailure(test, `Withdrawal rewards 操作失败: ${error.message}`, { throwError: true });
    }
}


/**
 * 新版返佣的邀请链接
 */
export async function earnInviteLink(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '页面已关闭，跳过操作');
        }

        // 点击邀请按钮
        const isVisible = await clickIfTextExists(page, 'INVITE FRIENDS FOR REWARDS', {
            name: '新版返佣的邀请链接按钮',
            timeout: 5000
        });

        if (!isVisible) {
            return await handleFailure(test, '邀请按钮不可见，跳过', { throwError: true });
        }

        // 等待页面切换
        await test.switchToPage('进入新版返佣的邀请界面', {
            waitForSelector: 'text=Share',
            waitTime: 1000,
            collectPreviousPage: true,
        });

        // 等待页面稳定
        await page.waitForTimeout(1000);

        // 检查页面是否仍然打开
        if (page.isClosed()) {
            return await handleFailure(test, '页面在切换后关闭');
        }

        // 进行页面的完整性判断
        const inviteCodeElement = page.locator('.invite .code span');
        const codeVisible = await inviteCodeElement.isVisible({ timeout: 3000 }).catch(() => false);

        if (!codeVisible) {
            return await handleFailure(test, '邀请码元素不可见');
        }

        const inviteCode = await inviteCodeElement.innerText();

        if (!inviteCode || inviteCode.trim() === '') {
            return await handleFailure(test, '邀请码为空，页面数据异常', { throwError: true });
        } else {
            console.log(`        ✅ 邀请码: ${inviteCode}`);
        }

        // 使用封装的 Telegram 跳转函数
        const jumpResult = await handleTelegramJump(page, '.share-icons', {
            telegramText: 'Telegram',
            jumpTimeout: 5000,
            waitAfterBack: 1000,
            verifyReturn: true,
            name: '新版返佣->邀请链接->Telegram'
        });

        if (!jumpResult.success) {
            console.log(`        ⚠️ Telegram 跳转验证失败: ${jumpResult.error || '未知错误'}`);
            // 邀请码验证成功，只是跳转功能不可用
            return true;
        }

        return true;

    } catch (error) {
        return await handleFailure(test, `earnInviteLink 执行失败: ${error.message}`, { throwError: true });
    }
}

/**
 * 新版返佣的排行榜的界面Invite Rewards -- 进入返佣排行榜的个人详情页
 */
export async function earnInviteRewardsRankInfo(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '页面已关闭，跳过操作');
        }

        // 点击切换到Invite Rewards界面
        const isVisible = await clickIfTextExists(page, 'Invite Rewards', {
            name: '新版返佣的排行榜的界面'
        });

        if (!isVisible) {
            return await handleFailure(test, '新版返佣的排行榜的界面Invite Rewards不可见，跳过');
        }

        const isJump = await test.switchToPage('进入返佣排行榜的排行榜的界面', {
            waitForSelector: 'text=Check the list detail',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isJump) {
            return await handleFailure(test, '进入返佣排行榜的排行榜的界面->页面切换失败');
        }

        // 等待元素出现
        await page.waitForSelector('.ranking-icon');
        // 点击 SVG
        await page.locator('.ranking-icon svg').click();

        const isRewards = await test.switchToPage('进入返佣排行榜的个人详情的界面', {
            waitForSelector: 'text=My Rewards',
            waitTime: 1000,
            collectPreviousPage: true
        });
        if (!isRewards) {
            return await handleFailure(test, '进入返佣排行榜的个人详情的界面->页面切换失败');
        }
        // 等待2s   
        await page.waitForTimeout(2000);
        return true;
    } catch (error) {
        return await handleFailure(test, `earnInviteRewardsRankInfo 执行失败: ${error.message}`, { throwError: true });
    }
}


/**
 * 进入history
 */
export async function earnInviteRewardsHistory(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '进入history->页面已关闭，跳过操作');
        }

        // 点击切换到Invite Rewards界面
        const isVisible = await clickIfTextExists(page, 'Invite Rewards', {
            name: '进入history->新版返佣的排行榜的界面'
        });

        if (!isVisible) {
            return await handleFailure(test, '进入history->新版返佣的排行榜的界面Invite Rewards不可见，跳过');
        }

        const isJump = await test.switchToPage('进入history->进入返佣排行榜的排行榜的界面', {
            waitForSelector: 'text=Check the list detail',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isJump) {
            return await handleFailure(test, '进入history->进入返佣排行榜的排行榜的界面->页面切换失败');
        }

        // 找到history进行点击
        const isVisibleHistory = await clickIfTextExists(page, 'History', {
            name: '进入history->新版返佣的排行榜的界面'
        });

        if (!isVisibleHistory) {
            return await handleFailure(test, '进入history->histroyory不可见，跳过');
        }
        // 进入到了history的界面
        const isHistoryview = await test.switchToPage('进入返佣排行榜的history的界面', {
            waitForSelector: 'text=History',
            waitTime: 1000,
            collectPreviousPage: true
        });
        if (!isHistoryview) {
            return await handleFailure(test, '进入history的界面->页面切换失败');
        }
        await page.waitForTimeout(1000);
        return true;
    } catch (error) {
        return await handleFailure(test, `进入history->earnInviteRewardsHistory 执行失败: ${error.message}`, { throwError: true });
    }
}

/**
 * 进入Rules
 */
export async function earnInviteRewardsRules(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '进入Rules->页面已关闭，跳过操作');
        }

        // 点击切换到Invite Rewards界面
        const isVisible = await clickIfTextExists(page, 'Invite Rewards', {
            name: '进入Rules->新版返佣的排行榜的界面'
        });

        if (!isVisible) {
            return await handleFailure(test, '进入Rules->新版返佣的排行榜的界面Invite Rewards不可见，跳过');
        }

        const isJump = await test.switchToPage('进入Rules->进入返佣排行榜的排行榜的界面', {
            waitForSelector: 'text=Check the list detail',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isJump) {
            return await handleFailure(test, '进入Rules->进入返佣排行榜的排行榜的界面->页面切换失败');
        }

        // 找到Rules进行点击
        const isVisibleRules = await clickIfTextExists(page, 'Rules', {
            name: '进入Rules->新版返佣的排行榜的界面'
        });

        if (!isVisibleRules) {
            return await handleFailure(test, '进入Rules->Rules不可见，跳过');
        }

        // 进入到了Rules的界面
        const isRulesview = await test.switchToPage('进入返佣排行榜的Rules的界面', {
            waitForSelector: 'text=Rules',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isRulesview) {
            return await handleFailure(test, '进入Rules的界面->页面切换失败');
        }

        const result = await verifyElementContent(page, '.content');

        if (!result.exists) {
            return await handleFailure(test, '新版返佣的规则的content不存在，所以规则没有内容');
        } else if (result.isEmpty) {
            return await handleFailure(test, '新版返佣的规则没有内容');
        } else {
            console.log('✅ 新版返佣的规则有内容');
        }
        return true;
    } catch (error) {
        return await handleFailure(test, `进入Rules->earnInviteRewardsRules 执行失败: ${error.message}`, { throwError: true });
    }
}


/**
 * 进入排行榜的榜单
 */
export async function earnInviteRewardsRanklist(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '进入Ranklist->页面已关闭，跳过操作');
        }

        // 点击切换到Invite Rewards界面
        const isVisible = await clickIfTextExists(page, 'Invite Rewards', {
            name: '进入Ranklist->新版返佣的排行榜的界面'
        });

        if (!isVisible) {
            return await handleFailure(test, '进入Ranklist->新版返佣的排行榜的界面Invite Rewards不可见，跳过');
        }

        const isJump = await test.switchToPage('进入Ranklist->进入返佣排行榜的排行榜的界面', {
            waitForSelector: 'text=Check the list detail',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isJump) {
            return await handleFailure(test, '进入Ranklist->进入返佣排行榜的排行榜的界面->页面切换失败');
        }

        // 找到"Check the list detail"进行点击
        const isVisibleRanklist = await clickIfTextExists(page, 'Check the list detail', {
            name: '进入Ranklist->新版返佣的排行榜的界面'
        });

        if (!isVisibleRanklist) {
            return await handleFailure(test, '进入Ranklist->Check the list detail不可见，跳过');
        }

        // 进入到了Ranklist的界面
        const isRanklistview = await test.switchToPage('进入返佣排行榜的Ranklist的界面', {
            waitForSelector: '.box',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isRanklistview) {
            return await handleFailure(test, '进入Ranklist的界面->页面切换失败');
        }

        await page.waitForTimeout(2000);

        // 等待页面加载
        await page.waitForSelector('.box .body');
        // 执行滑动加载
        await scrollToLoadAll(page, '.box .body', '.item', 8);

        return true;
    } catch (error) {
        return await handleFailure(test, `进入Ranklist->earnInviteRewardsRanklist 执行失败: ${error.message}`, { throwError: true });
    }
}


/**
 * 进入邀请链接
 */
export async function earnInviteRewardsInviteLink(page, test) {
    try {
        // 检查页面是否已关闭
        if (!page || page.isClosed()) {
            return await handleFailure(test, '进入InviteLink->页面已关闭，跳过操作');
        }

        // 点击切换到Invite Rewards界面
        const isVisible = await clickIfTextExists(page, 'Invite Rewards', {
            name: '进入InviteLink->新版返佣的排行榜的界面'
        });

        if (!isVisible) {
            return await handleFailure(test, '进入InviteLink->新版返佣的排行榜的界面Invite Rewards不可见，跳过');
        }

        const isJump = await test.switchToPage('进入InviteLink->进入返佣排行榜的排行榜的界面', {
            waitForSelector: 'text=Check the list detail',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isJump) {
            return await handleFailure(test, '进入InviteLink->进入返佣排行榜的排行榜的界面->页面切换失败');
        }

        // 找到"Invite link"进行点击
        const isVisibleInviteLink = await clickIfTextExists(page, 'Invite link', {
            name: '进入InviteLink->新版返佣的排行榜的界面'
        });

        if (!isVisibleInviteLink) {
            return await handleFailure(test, '进入InviteLink->Invite link不可见，跳过');
        }

        // 进入到了Invite link的界面
        const isInviteLinkview = await test.switchToPage('进入返佣排行榜的InviteLink的界面', {
            waitForSelector: 'text=Share',
            waitTime: 1000,
            collectPreviousPage: true
        });

        if (!isInviteLinkview) {
            return await handleFailure(test, '进入InviteLink的界面->页面切换失败');
        }

        await page.waitForTimeout(1000);

        return true;
    } catch (error) {
        return await handleFailure(test, `进入InviteLink->earnInviteRewardsInviteLink 执行失败: ${error.message}`, { throwError: true });
    }
}




